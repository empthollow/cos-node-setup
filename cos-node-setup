#!/bin/bash

# Error handling
# Exit script on first error
set -o errexit  
# Catch errors in pipelines
set -o pipefail 

handle_error() {
echo "=========================================================="
echo "$stage installation or execution error on ${BASH_LINENO[0]}, goodbye"
echo "=========================================================="
#sed -i /resume/s/0/1/ resume_status
exit 1
}

# Trap errors and call the error handler
trap 'handle_error $LINENO' ERR

[ "$(id -u)" -ne "0" ] && echo "you are not root: use 'sudo -s'" && exit



help()
{
echo "Syntax: cos-node-setup [ ARG ARG ARG ]
***valid arguments***:"
awk '/(controller|all|node|archetype|resume|help)\(\)/{print  }' cos-node-setup | sed "s/[{|\(|\)]//g"
}

generatepasswords() {
[ -e "openstack_passwords" ] && $(mv openstack_passwords openstack_passwords.bak)
echo "# Database password (no variable used) 
# Root password for the database

" >> openstack_passwords

admin_pass=$(openssl rand -hex 10)
echo "# Password of user admin
ADMIN_PASS=$admin_pass

" >> openstack_passwords

cinder_dbpass=$(openssl rand -hex 10)
echo "# Database password for the Block Storage service
CINDER_DBPASS=$cinder_dbpass

" >> openstack_passwords

cinder_pass=$(openssl rand -hex 10)
echo "# Password of Block Storage service user cinder
CINDER_PASS=$cinder_pass

" >> openstack_passwords

dash_dbpass=$(openssl rand -hex 10)
echo "# Database password for the Dashboard
DASH_DBPASS=$dash_dbpass

" >> openstack_passwords

myuser_pass=$(openssl rand -hex 10)
echo "# Password of user
MYUSER_PASS=$myuser_pass

" >> openstack_passwords

glance_dbpass=$(openssl rand -hex 10)
echo "# Database password for Image service
GLANCE_DBPASS=$glance_dbpass

" >> openstack_passwords

glance_pass=$(openssl rand -hex 10)
echo "# Password of Image service user glance
GLANCE_PASS=$glance_pass

" >> openstack_passwords

keystone_dbpass=$(openssl rand -hex 10)
echo "# Database password of Identity service
KEYSTONE_DBPASS=$keystone_dbpass

" >> openstack_passwords

metadata_secret=$(openssl rand -hex 10)
echo "# Secret for the metadata proxy
METADATA_SECRET=$metadata_secret

" >> openstack_passwords

neutron_dbpass=$(openssl rand -hex 10)
echo "# Database password for the Networking service
NEUTRON_DBPASS=$neutron_dbpass

" >> openstack_passwords

neutron_pass=$(openssl rand -hex 10)
echo "# Password of Networking service user neutron
NEUTRON_PASS=$neutron_pass

" >> openstack_passwords
	
nova_dbpass=$(openssl rand -hex 10)
echo "# Database password for Compute service
NOVA_DBPASS=$nova_dbpass

" >> openstack_passwords

nova_pass=$(openssl rand -hex 10)
echo "# Password of Compute service user nova
NOVA_PASS=$nova_pass

" >> openstack_passwords

placement_pass=$(openssl rand -hex 10)
echo "# password of the placement service user placement
PLACEMENT_PASS=$placement_pass

" >> openstack_passwords

placement_dbpass=$(openssl rand -hex 10)
echo "# password of the placement service user placement
PLACEMENT_DBPASS=$placement_dbpass

" >> openstack_passwords

rabbit_pass=$(openssl rand -hex 10)
echo "# Password of RabbitMQ user openstack
RABBIT_PASS=$rabbit_pass

" >> openstack_passwords

swift_pass=$(openssl rand -hex 10)
echo "# Password of RabbitMQ user openstack
SWIFT_PASS=$rabbit_pass

" >> openstack_passwords

. openstack_passwords

echo "========================================================================================"
echo "Your passwords are in the file $(pwd)/openstack_passwords"
echo "========================================================================================"
}

srcopenrc()
{
#check for admin openrc
if [ -e "admin-openrc" ]; then
	echo "admin-openrc found"
	osadmin=admin-openrc
	sleep 2
else
	echo -n "specify path (if no, files will be created) [y/n] >"
	read -t 5 specifypath || specifypath="n"
	if [ "$specifypath" == "y" ]; then  
		echo -n "enter path of admin-openrc or equivalent file > "
		read osadmin
	else
	# Create myuser and openrc auth files
				echo "export OS_PROJECT_DOMAIN_NAME=Default
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_NAME=admin
export OS_USERNAME=admin
export OS_PASSWORD=$ADMIN_PASS
export OS_AUTH_URL=http://controller:5000/v3
export OS_IDENTITY_API_VERSION=3
export OS_IMAGE_API_VERSION=2" > admin-openrc
		echo "==========================================================="
		echo "$(pwd)/admin-openrc created "
		echo "creating $myuser and openrc auth files in the current directory"
		osadmin=admin-openrc
		source $osadmin
		openstack user create --domain default --password $MYUSER_PASS $myuser
		echo "export OS_PROJECT_DOMAIN_NAME=Default
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_NAME=myproject
export OS_USERNAME=$myuser
export OS_PASSWORD=$MYUSER_PASS
export OS_AUTH_URL=http://controller:5000/v3
export OS_IDENTITY_API_VERSION=3
export OS_IMAGE_API_VERSION=2" > $myuser-openrc
		echo "$(pwd)/$myuser-openrc created "
		echo "==========================================================="
		sleep 4
	
	fi
fi
source $osadmin
if [ "$?" -gt "0" ]; then 
	echo "openrc auth error; exit or retry [r/x] > " 
	read retry
	[ "$retry" == "r" ] && srcopenrc || exit
fi

}

base_all() {
# install base node packages
stage=base
echo "==============================================="
echo "         setting up base packages  "
echo "==============================================="

dnf upgrade -y
dnf install -y dnf-plugins-core
dnf config-manager --set-enabled crb
dnf upgrade -y
dnf install -y centos-release-openstack-$release
dnf install -y python3-openstackclient openstack-selinux
dnf install -y python3-openstackclient openstack-selinux
sed -i /basestat/s/1/0/ resume_status
}

mariadb_controller() {
# Install MariaDB
stage=mariadb
echo "==============================================="
echo "             setting up mariadb      "
echo "==============================================="

dnf install -y mariadb mariadb-server python3-PyMySQL 
[ -e "/etc/my.cnf.d/openstack.cnf" ] && $(mv /etc/my.cnf.d/openstack.cnf /etc/my.cnf.d/openstack.bak)
echo "[mysqld]
bind-address = $controllerip

default-storage-engine = innodb
innodb_file_per_table = on
max_connections = 4096
collation-server = utf8_general_ci
character-set-server = utf8" > /etc/my.cnf.d/openstack.cnf
systemctl enable --now mariadb.service
### mysql -e "DELETE FROM mysql.user WHERE User='';"
### mysql -e "DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';"
### mysql -e "  MariaDB> DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');"
sed -i /mariadbstat/s/1/0/ resume_status
}

rabbitmq_controller() {
# Message Queue - Rabbit MQ
stage=rabbitmq
echo "==============================================="
echo "           setting up rabbit mq "
echo "==============================================="

dnf install -y rabbitmq-server
systemctl enable --now rabbitmq-server
rabbitmqctl add_user openstack $RABBIT_PASS
rabbitmqctl set_permissions openstack ".*" ".*" ".*"
sed -i /rabbitmqstat/s/1/0/ resume_status
}

memcached_controller() {
# Memcached
stage=memcached

echo "==============================================="
echo "            setting up memcached "
echo "==============================================="

dnf install -y memcached python3-memcached
sed -i s/'OPTIONS="-l 127.0.0.1,::1"/OPTIONS="-l 127.0.0.1,::1,controller"'/ /etc/sysconfig/memcached
systemctl enable --now memcached.service
sed -i /memcachedstat/s/1/0/ resume_status
}

etcd_all() {
# ETCd
stage=etcd
echo "==============================================="
echo "              setting up ETCd "
echo "==============================================="

dnf install -y etcd
sed -i 's/^[^#]/#/' /etc/etcd/etcd.conf
[ -z "$controllerip" ] && echo -n "Enter controller ip" && read controllerip
echo "#[Member]
ETCD_DATA_DIR=\"/var/lib/etcd/default.etcd\"
ETCD_LISTEN_PEER_URLS=\"http://$controllerip:2380\"
ETCD_LISTEN_CLIENT_URLS=\"http://$controllerip:2379\"
ETCD_NAME=\"controller\"
#[Clustering]
ETCD_INITIAL_ADVERTISE_PEER_URLS=\"http://$controllerip:2380\"
ETCD_ADVERTISE_CLIENT_URLS=\"http://$controllerip:2379\"
ETCD_INITIAL_CLUSTER=\"controller=http://$controllerip:2380\"
ETCD_INITIAL_CLUSTER_TOKEN=\"etcd-cluster-01\"
ETCD_INITIAL_CLUSTER_STATE=\"new\"" >> /etc/etcd/etcd.conf
systemctl enable --now etcd
sed -i /etcdstat/s/1/0/ resume_status
}

keystone_controller() {
# Install Keystone
stage=keystone
echo "==============================================="
echo "            setting up Keystone "
echo "==============================================="

mysql -e "CREATE DATABASE keystone;"
mysql -e "GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' IDENTIFIED BY '$KEYSTONE_DBPASS';"
mysql -e "GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' IDENTIFIED BY '$KEYSTONE_DBPASS';"
dnf install -y openstack-keystone httpd mod_wsgi

sed -i "/\[database\]/a connection = mysql+pymysql://keystone:$KEYSTONE_DBPASS@controller/keystone" /etc/keystone/keystone.conf
sed -i '/\^[token\]/a provider = fernet' /etc/keystone/keystone.conf
su -s /bin/sh -c "keystone-manage db_sync" keystone
keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone
keystone-manage credential_setup --keystone-user keystone --keystone-group keystone
keystone-manage bootstrap --bootstrap-password $ADMIN_PASS \
  --bootstrap-admin-url http://controller:5000/v3/ \
  --bootstrap-internal-url http://controller:5000/v3/ \
  --bootstrap-public-url http://controller:5000/v3/ \
  --bootstrap-region-id RegionOne
sed -i '/\#ServerName/a ServerName controller' /etc/httpd/conf/httpd.conf
ln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/
systemctl enable --now httpd.service

# Set Keystone Environment Variables
echo "setting up Keystone environment variables ..."
export OS_USERNAME=admin
export OS_PASSWORD=$ADMIN_PASS
export OS_PROJECT_NAME=admin
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_DOMAIN_NAME=Default
export OS_AUTH_URL=http://controller:5000/v3
export OS_IDENTITY_API_VERSION=3
sed -i /keystonestat/s/1/0/ resume_status
}

glance_controller() {
# Install Glance
stage=glance
echo "==============================================="
echo "             setting up glance"
echo "==============================================="

mysql -e "CREATE DATABASE glance;"
mysql -e "GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' \
  IDENTIFIED BY '$GLANCE_DBPASS';"
mysql -e "GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' \
  IDENTIFIED BY '$GLANCE_DBPASS';"

echo "creating glance user ..."
#get admin-openrc
echo "openrc"
srcopenrc
echo "os create user"
openstack user create --domain default --password $GLANCE_PASS glance
echo "os create project service"
openstack project create service
echo "os role add"
openstack role add --project service --user glance admin
echo "creating service identity ..."
openstack service create --name glance --description "OpenStack Image" image
echo "creating api endpoints"
openstack endpoint create --region RegionOne image public http://controller:9292
openstack endpoint create --region RegionOne image internal http://controller:9292
openstack endpoint create --region RegionOne image admin http://controller:9292
echo "================================================================"
echo "     not setting quota limits - see openstack documentation "
echo "================================================================"

# Install & Configure components
echo "installing glance"
dnf install -y openstack-glance
echo "configuring glance files" 
sed -i "/^\[database\]/a connection = mysql+pymysql://glance:$GLANCE_DBPASS@controller/glance" /etc/glance/glance-api.conf 
sed -i "/^\[keystone_authtoken\]/a www_authenticate_uri = http://controller:5000\nauth_url = http://controller:5000\nmemcached_servers = controller:11211\nauth_type = password\nproject_domain_name = Default\nuser_domain_name = Default\nproject_name = service\nusername = glance\npassword = $GLANCE_PASS" /etc/glance/glance-api.conf
sed -i '/^\#enabled_backends/a enabled_backends=fs:file' /etc/glance/glance-api.conf
sed -i '/^\#default_backend/a default_backend = fs' /etc/glance/glance-api.conf
sed -i 's@\#filesystem_store_datadir@filesystem_store_datadir = /var\/lib\/glance\/images/@' /etc/glance/glance-api.conf
sed -i "/^\[oslo_limit\]/a www_authenticate_uri = http://controller:5000\nauth_url = http://controller:5000\nmemcached_servers = controller:11211\nauth_type = password\nproject_domain_name = Default\nuser_domain_name = Default\nproject_name = service\nusername = glance\npassword = $GLANCE_PASS"  /etc/glance/glance-api.conf
###	sed -i "s/GLANCE_PASS/$GLANCE_PASS/g" /etc/glance/glance-api.conf
###	sed -i "s/GLANCE_DBPASS/$GLANCE_DBPASS/g" /etc/glance/glance-api.conf
echo "setting role permissions"
openstack role add --user glance --user-domain Default --system all reader
echo "populating images"
su -s /bin/sh -c "glance-manage db_sync" glance
echo "starting daemon"
systemctl enable --now openstack-glance-api.service
sed -i /glancestat/s/1/0/ resume_status
}

placement_controller()
{
stage=placement
echo "==============================================="
echo "   setting up placment for controller node"
echo "==============================================="

mysql -e "CREATE DATABASE placement;"
mysql -e "GRANT ALL PRIVILEGES ON placement.* TO 'placement'@'localhost' IDENTIFIED BY '$PLACEMENT_DBPASS';" 
mysql -e "GRANT ALL PRIVILEGES ON placement.* TO 'placement'@'%' IDENTIFIED BY '$PLACEMENT_DBPASS';"
srcopenrc
openstack user list | grep -cw placement || openstack user create --domain default --password $PLACEMENT_PASS placement
openstack role add --project service --user placement admin
openstack service create --name placement --description "Placement API" placement
openstack endpoint create --region RegionOne placement public http://controller:8778
openstack endpoint create --region RegionOne placement internal http://controller:8778
openstack endpoint create --region RegionOne placement admin http://controller:8778
dnf install -y openstack-placement-api python3-osc-placement

echo "writing placment config ..."
sed -i "/^\[placement_database\]/a connection = mysql+pymysql://placement:$PLACEMENT_DBPASS@controller/placement" /etc/placement/placement.conf
sed -i "/^\[api\]/a auth_strategy = keystone" /etc/placement/placement.conf
sed -i "/^\[keystone_authtoken\]/a auth_url = http://controller:5000/v3 \nmemcached_servers = controller:11211 \nauth_type = password \nproject_domain_name = Default \nuser_domain_name = Default \nproject_name = service \nusername = placement \npassword = $PLACEMENT_PASS" /etc/placement/placement.conf

echo "populating placement database..."
su -s /bin/sh -c "placement-manage db sync" placement

echo "restarting server..."
systemctl restart httpd
read -p "press enter to continue" go
sed -i /placementstat/s/1/0/ resume_status
}

nova_controller() {
# Install Nova - Controller Node
stage="nova controller"
echo "==============================================="
echo "     setting up nova for controller node"
echo "==============================================="

echo "mysql setup..."
mysql -e "CREATE DATABASE nova_api;"
mysql -e "CREATE DATABASE nova;"
mysql -e "CREATE DATABASE nova_cell0;"
mysql -e "GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'localhost' \
  IDENTIFIED BY '$NOVA_DBPASS';"
mysql -e "GRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'%' \
  IDENTIFIED BY '$NOVA_DBPASS';"
mysql -e "GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'localhost' \
  IDENTIFIED BY '$NOVA_DBPASS';"
mysql -e "GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%' \
  IDENTIFIED BY '$NOVA_DBPASS';"
mysql -e "GRANT ALL PRIVILEGES ON nova_cell0.* TO 'nova'@'localhost' \
  IDENTIFIED BY '$NOVA_DBPASS';"
mysql -e "GRANT ALL PRIVILEGES ON nova_cell0.* TO 'nova'@'%' \
  IDENTIFIED BY '$NOVA_DBPASS';"

# adding nova user
echo "configuring openstack user"
srcopenrc
openstack user create --domain default --password $NOVA_PASS nova
openstack role add --project service --user nova admin

# creating nova services
openstack service create --name nova --description "OpenStack Compute" compute

# creating nova api endpoints 
openstack endpoint create --region RegionOne compute public http://controller:8774/v2.1
openstack endpoint create --region RegionOne compute internal http://controller:8774/v2.1
openstack endpoint create --region RegionOne compute admin http://controller:8774/v2.1

dnf install -y openstack-nova-api openstack-nova-conductor  openstack-nova-novncproxy openstack-nova-scheduler

sed -i "/^\[DEFAULT\]/a enabled_apis = osapi_compute,metadata \ntransport_url = rabbit://openstack:$RABBIT_PASS@controller:5672/\nmy_ip = $controllerip"  /etc/nova/nova.conf
sed -i "/^\[api_database\]/a connection = mysql+pymysql://nova:$NOVA_DBPASS@controller/nova_api" /etc/nova/nova.conf
sed -i "/^\[database\]/a connection = mysql+pymysql://nova:$NOVA_DBPASS@controller/nova" /etc/nova/nova.conf
sed -i "/^\[api\]/a \# ...\nauth_strategy = keystone" /etc/nova/nova.conf
sed -i "/^\[keystone_authtoken\]/a \nwww_authenticate_uri = http://controller:5000/\nauth_url = http://controller:5000/\nmemcached_servers = controller:11211\nauth_type = password\nproject_domain_name = Default\nuser_domain_name = Default\nproject_name = service\nusername = nova\npassword = $NOVA_PASS" /etc/nova/nova.conf
sed -i "/^\[service_user\]/a send_service_user_token = true\nauth_url = https://controller/identity\nauth_strategy = keystone\nauth_type = password\nproject_domain_name = Default\nproject_name = service\nuser_domain_name = Default\nusername = nova\npassword = $NOVA_PASS" /etc/nova/nova.conf
sed -i "/^\[vnc\]/a enabled = true\nserver_listen = $controllerip\nserver_proxyclient_address = $controllerip" /etc/nova/nova.conf
sed -i "/^\[glance\]/a api_servers = http://controller:9292" /etc/nova/nova.conf
sed -i "/^\[oslo_concurrency\]/a lock_path = /var/lib/nova/tmp" /etc/nova/nova.conf
sed -i "/^\[placement\]/a region_name = RegionOne\nproject_domain_name = Default\nproject_name = service\nauth_type = password\nuser_domain_name = Default\nauth_url = http://controller:5000/v3\nusername = placement\npassword = $PLACEMENT_PASS" /etc/nova/nova.conf
sed -i "/^\[scheduler\]/a discover_hosts_in_cells_interval = 300" /etc/nova/nova.conf

# populate nova-api db
su -s /bin/sh -c "nova-manage api_db sync" nova
su -s /bin/sh -c "nova-manage cell_v2 map_cell0" nova
su -s /bin/sh -c "nova-manage cell_v2 create_cell --name=cell1 --verbose" nova
su -s /bin/sh -c "nova-manage db sync" nova
su -s /bin/sh -c "nova-manage cell_v2 list_cells" nova

# enable services
systemctl enable \
openstack-nova-api.service \
openstack-nova-scheduler.service \
openstack-nova-conductor.service \
openstack-nova-novncproxy.service

# start services
systemctl start \
openstack-nova-api.service \
openstack-nova-scheduler.service \
openstack-nova-conductor.service 
sed -i /novactlstat/s/1/0/ resume_status
}

nova_node()
{
# install nova
stage=novanode
echo "==============================================="
echo "      installing nove for compute node"
echo "==============================================="

dnf install -y openstack-nova-compute

# write configs
sed -i "/^\[DEFAULT\]/a enabled_apis = osapi_compute,metadata \ntransport_url = rabbit://openstack:$RABBIT_PASS@controller:5672/\nmy_ip = $controllerip"  /etc/nova/nova.conf
sed -i "/^\[api\]/a \# ...\nauth_strategy = keystone" /etc/nova/nova.conf
sed -i "/^\[keystone_authtoken\]/a www_authenticate_uri = http://controller:5000/\nauth_url = http://controller:5000/\nmemcached_servers = controller:11211\nauth_type = password\nproject_domain_name = Default\nuser_domain_name = Default\nproject_name = service\nusername = nova\npassword = $NOVA_PASS" /etc/nova/nova.conf
sed -i "/^\[service_user\]/a send_service_user_token = true\nauth_url = https://controller/identity\nauth_strategy = keystone\nauth_type = password\nproject_domain_name = Default\nproject_name = service\nuser_domain_name = Default\nusername = nova\npassword = $NOVA_PASS" /etc/nova/nova.conf
sed -i "/^\[vnc\]/a enabled = true\nserver_listen = 0.0.0.0\nserver_proxyclient_address = $computeip\nnovncproxy_base_url = http://controller:6080/vnc_auto.html"
sed -i "/^\[glance\]/a api_servers = http://controller:9292"
sed -i "/^\[oslo_concurrency\]/a lock_path = /var/lib/nova/tmp"
sed -i "/^\[placement\]/a region_name = RegionOne\nproject_domain_name = Default\nproject_name = service\nauth_type = password\nuser_domain_name = Default\nauth_url = http://controller:5000/v3\nusername = placement\npassword = $PLACEMENT_PASS" /etc/nova/nova.conf

# finalize installation

if [ "$(egrep -c '(vmx|svm)' /proc/cpuinfo)" ]; then
	echo "this machine supports hardware acceleration\nnova configuration complete"
else
	sed -i "/^\[libvirt\]/a qemu"
	echo "this machine does not support hardware acceleration\nusing quemu\nova configuration complete"
fi

# set services up
systemctl enable libvirtd.service openstack-nova-compute.service
systemctl start libvirtd.service openstack-nova-compute.service
sed -i /novanodestat/s/1/0/ resume_status

echo "nova compute (node) set up; run the following to discover hosts manually on the controller node\nsu -s /bin/sh -c \"nova-manage cell_v2 discover_hosts --verbose\" nova"
echo "press enter to continue"
read
}

cinder_controller()
{
# install cinder control server
stage=cinderctl
echo "==============================================="
echo "      installing cinder for contoller"
echo "==============================================="

# database setup
mysql -e "CREATE DATABASE cinder;"
mysql -e "GRANT ALL PRIVILEGES ON cinder.* TO 'cinder'@'localhost' IDENTIFIED BY '$CINDER_DBPASS';"
mysql -e "GRANT ALL PRIVILEGES ON cinder.* TO 'cinder'@'%' IDENTIFIED BY '$CINDER_DBPASS';"

# openstack setup
srcopenrc
openstack user create --domain default --password $CINDER_PASS cinder
openstack role add --project service --user cinder admin
openstack service create --name cinderv3 --description "OpenStack Block Storage" volumev3
openstack endpoint create --region RegionOne volumev3 public http://controller:8776/v3/%\(project_id\)s
openstack endpoint create --region RegionOne volumev3 internal http://controller:8776/v3/%\(project_id\)s
openstack endpoint create --region RegionOne volumev3 admin http://controller:8776/v3/%\(project_id\)s

# install and write config files
dnf install -y openstack-cinder

sed -i "/^\[DEFAULT\]/a transport_url = rabbit://openstack:$RABBIT_PASS@controller\nauth_strategy = keystone\nmy_ip = $controllerip" /etc/cinder/cinder.conf
sed -i "/^\[keystone_authtoken\]/a www_authenticate_uri = http://controller:5000\nauth_url = http://controller:5000\nmemcached_servers = controller:11211\nauth_type = password\nproject_domain_name = default\nuser_domain_name = default\nproject_name = service\nusername = cinder\npassword = $CINDER_PASS" /etc/cinder/cinder.conf
sed -i "/^\[[oslo_concurrency\]/a lock_path = /var/lib/cinder/tmp" /etc/cinder/cinder.conf
sed -i "/^\[cinder\]/a os_region_name = RegionOne" /etc/nova/nova.conf

# populate database
echo "populating database ..."
su -s /bin/sh -c "cinder-manage db sync" cinder

# start services
systemctl restart openstack-nova-api.service
systemctl enable openstack-cinder-api.service openstack-cinder-scheduler.service
systemctl start openstack-cinder-api.service openstack-cinder-scheduler.service
sed -i /cinderctlstat/s/1/0/ resume_status
}

cinder_node()
{
# install cinder node
stage=cindernode
echo "==============================================="
echo "   installing cinder for block storage node"
echo "==============================================="

pvcreate /dev/$cinderdev
vgcreate cinder-volumes /dev/$cinderdev
sed -i "/^devices/a filter = [ \"a/$cinderdev/\", \"r/.*/\"" /etc/lvm/lvm.conf

# install and configure
dnf install -y openstack-cinder targetcli

sed -i "/^\[DEFAULT\]/a my_ip = $cinderctrlip\nenabled_backends = lvm\nglance_api_servers = http://controller:9292\ntransport_url = rabbit://openstack:$RABBIT_PASS@controller\nauth_strategy = keystone" /etc/lvm/lvm.conf

sed -i "/^\[database\]/a connection = mysql+pymysql://cinder:$CINDER_DBPASS@controller/cinder" /etc/lvm/lvm.conf
sed -i "/^\[lvm\]/a \nvolume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver\nvolume_group = cinder-volumes\ntarget_protocol = iscsi\ntarget_helper = lioadm" /etc/lvm/lvm.conf
sed -i "/^\[oslo_concurrency\]/a lock_path = /var/lib/cinder/tmp" /etc/lvm/lvm.conf
sed -i "/^\[keystone_authtoken\]/a \nwww_authenticate_uri = http://controller:5000\nauth_url = http://controller:5000\nmemcached_servers = controller:11211\nauth_type = password\nproject_domain_name = default\nuser_domain_name = default\nproject_name = service\nusername = cinder\npassword = $CINDER_PASS" /etc/lvm/lvm.conf

# start and enable services
systemctl enable openstack-cinder-volume.service target.service
systemctl start openstack-cinder-volume.service target.service

sed -i /cindernodestat/s/1/0/ resume_status
}

cinderbackup_node()
{
stage="cinder for backup node ***swift required***"
echo "==============================================="
echo "      setting up cinder for backup node"
echo "==============================================="

dnf install -y openstack-cinder
srcopenrc
SWIFT_URL=$(openstack catalog show object-store | grep -o -E 'http[s]?://[^ ]+' | sed -n '1p')
sed -i "/^\[DEFAULT\]/a backup_driver = cinder.backup.drivers.swift.SwiftBackupDriver\nbackup_swift_url = $SWIFT_URLl" /etc/nova/nova.conf

# start services
systemctl enable openstack-cinder-backup.service
systemctl start openstack-cinder-backup.service

sed -i /cinderbackupstat/s/1/0/ resume_status
}

horizon()
{
# install horizon dashboard
stage="horizon dashboard"
echo "==============================================="
echo "       installing horizon dashboard"
echo "==============================================="

dnf install -y openstack-dashboard

# config files

# local_settings file
linemcd=$(awk '/^#CACHES/{ print NR }' /etc/openstack-dashboard/local_settings)
echo 1
sed -i ""$linemcd"c\#$'\t'\ \'LOCATION\':\ \'controller:11211\'," /etc/openstack-dashboard/local_settings 
echo 2
sed -i "$linemcd,$(awk 'BEGIN { print $linemcd+5 }')s/^#//" /etc/openstack-dashboard/local_settings
echo 3
sed -i "$(awk '/^OPENSTACK_HOST/{ print NR }' /etc/openstack-dashboard/local_settings)s/127.0.0.1/controller/" /etc/openstack-dashboard/local_settings
echo 4
sed -i "$(awk '/^OPENSTACK_KEYSTONE_URL/{ print NR }' /etc/openstack-dashboard/local_settings)a OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True" /etc/openstack-dashboard/local_settings
echo 5
IFS=","
hzcleanedhosts=$(for x in $hzallowedhosts; do echo -n "'$x', "; done)
echo 6
sed -i "$(awk '/^ALLOWED_HOSTS/{ print NR }' /etc/openstack-dashboard/local_settings)s/'horizon.example.com',/$hzcleanedhosts/" /etc/openstack-dashboard/local_settings
echo 7
sed -i "$(awk '/^OPENSTACK_KEYSTONE_URL/{ print NR }' /etc/openstack-dashboard/local_settings)a OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True\nOPENSTACK_API_VERSIONS = {\n\t\"identity\": 3,\n\t\"image\": 2,\n\t\"volume\": 3,\n}\n\nOPENSTACK_KEYSTONE_DEFAULT_DOMAIN = \"Default\"\nOPENSTACK_KEYSTONE_DEFAULT_ROLE = \"user\"" /etc/openstack-dashboard/local_settings
echo 8
sed -i "$(awk '/^TIME_ZONE/{ print NR }' /etc/openstack-dashboard/local_settings)s/"UTC"/$svrtz/" /etc/openstack-dashboard/local_settings
echo 9

# openstack-dashboard.conf file
sed -i "/WSGIProcessGroup\ dashboard/aWSGIApplicationGroup\ %{GLOBAL}" /etc/httpd/conf.d/openstack-dashboard.conf

sed -i /horizonstat/s/1/0/ resume_status
}

neutron_controller()
{
# install neutron networking on controller node
stage="connectivity to compute node"
ping -c 1 -w computeip &>null

stage="neutron controller"
echo "==============================================="
echo "      installing neutron for controller"
echo "==============================================="

# configure openstack
srcopenrc
openstack user create --domain default --password $NEUTRON_PASS neutron
openstack role add --project service --user neutron admin
openstack service create --name neutron --description "OpenStack Networking" network
openstack endpoint create --region RegionOne network public http://controller:9696
openstack endpoint create --region RegionOne network internal http://controller:9696
openstack endpoint create --region RegionOne network admin http://controller:9696

# install and mod config files
dnf install -y openstack-neutron openstack-neutron-ml2 openstack-neutron-openvswitch ebtables

# config neutron.conf
sed -i "/^\[database\]/a connection = mysql+pymysql://neutron:$NEUTRON_DBPASS@controller/neutron" /etc/neutron/neutron.conf
sed -i "/^\[DEFAULT\]/a core_plugin \= ml2\nservice_plugins \= router\ntransport_url \= rabbit://openstack:$RABBIT_PASS@controller\nauth_strategy \= keystone\nnotify_nova_on_port_status_changes \= true\nnotify_nova_on_port_data_changes \= true" /etc/neutron/neutron.conf
sed -i "/^\[keystone_authtoken\]/a www_authenticate_uri = http://controller:5000\nauth_url = http://controller:5000\nmemcached_servers = controller:11211\nauth_type = password\nproject_domain_name = Default\nuser_domain_name = Default\nproject_name = service\nusername = neutron\npassword = $NEUTRON_PASS" /etc/neutron/neutron.conf
sed -i "/^\[[oslo_concurrency\]/a lock_path = /var/lib/neutron/tmp" /etc/neutron/neutron.conf
sed -i "/^\[nova\]/a auth_url = http://controller:5000\nauth_type = password\nproject_domain_name = Default\nuser_domain_name = Default\nregion_name = RegionOne\nproject_name = service\nusername = nova\npassword = $NOVA_PASS" /etc/neutron/neutron.conf

# Configure the Modular Layer 2 (ML2) plug-in
sed -i "/^\[ml2\]/a type_drivers = flat,vlan,vxlan\ntenant_network_types = vxlan
\nmechanism_drivers = openvswitch,l2population\nextension_drivers = port_security" /etc/neutron/plugins/ml2/ml2_conf.ini
sed -i "/^\[ml2_type_flat\]/a flat_networks = provider" /etc/neutron/plugins/ml2/ml2_conf.ini
sed -i "/^\[ml2_type_vxlan\]/a vni_ranges = 1:1000" /etc/neutron/plugins/ml2/ml2_conf.ini

# Configure the Open vSwitch agent¶
sed -i "/^\ovs[\]/a bridge_mappings = provider:$provideriface" /etc/neutron/plugins/ml2/openvswitch_agent.ini
sed -i "/^\[vxlan\]/a local_ip = $overlayrip\nl2_population = true" /etc/neutron/plugins/ml2/openvswitch_agent.ini 
sed -i "/^\[securitygroup\]/a enable_security_group = true\nfirewall_driver = openvswitch" /etc/neutron/plugins/ml2/openvswitch_agent.ini

# Configure the layer-3 agent¶
sed -i "/^\[DEFAULT\]/a interface_driver = openvswitch" /etc/neutron/l3_agent.ini

# Configure the DHCP agent¶
sed -i "/^\[DEFAULT\]/a interface_driver = openvswitch\ndhcp_driver = neutron.agent.linux.dhcp.Dnsmasq\nenable_isolated_metadata = true" /etc/neutron/dhcp_agent.ini

sed -i /neutronctrlstat/s/1/0/ resume_status
}

neutron_compute_node()
{
# install neutron networking on compute node
stage="connectivity to controller"

ping -c 1 -w controllerip &>null
stage="neutron compute node" 
echo "==============================================="
echo "     installing neutron for compute node"
echo "==============================================="

# install neutron package
dnf install -y openstack-neutron-openvswitch

# configure neutron.conf
sed -i "/^\[DEFAULT\]/a transport_url \= rabbit://openstack:$RABBIT_PASS@controller\nauth_strategy \= keystone" /etc/neutron/neutron.conf
sed -i "/^\[keystone_authtoken\]/a www_authenticate_uri = http://controller:5000\nauth_url = http://controller:5000\nmemcached_servers = controller:11211\nauth_type = password\nproject_domain_name = Default\nuser_domain_name = Default\nproject_name = service\nusername = neutron\npassword = $NEUTRON_PASS" /etc/neutron/neutron.conf
sed -i "/^\[[oslo_concurrency\]/a lock_path = /var/lib/neutron/tmp" /etc/neutron/neutron.conf

# Configure the Open vSwitch agent¶
sed -i "/^\ovs[\]/a bridge_mappings = provider:$provideriface" /etc/neutron/plugins/ml2/openvswitch_agent.ini
sed -i "/^\[vxlan\]/a local_ip = $overlayip\nl2_population = true" /etc/neutron/plugins/ml2/openvswitch_agent.ini sed -i "/^\[securitygroup\]/a " /etc/neutron/plugins/ml2/openvswitch_agent.ini
sed -i "/^\[securitygroup\]/a enable_security_group = true\nfirewall_driver = openvswitch" /etc/neutron/plugins/ml2/openvswitch_agent.ini

# configure compute to use networking
sed -i "/^\[neutron\]/a auth_url = http://controller:5000\nauth_type = password\nproject_domain_name = Default\nuser_domain_name = Default\nregion_name = RegionOne\nproject_name = service\nusername = neutron\npassword = $NEUTRON_PASS" /etc/nova/nova.conf

# start / restart services
systemctl restart openstack-nova-compute.service
systemctl enable neutron-openvswitch-agent.service
systemctl start neutron-openvswitch-agent.service

sed -i /neutroncomputestat/s/1/0/ resume_status
}

neutron_block_node()
{
# install neutron networking on block storage node
stage="connectivity to compute1"
ping -c 1 -w  &>null
stage="neutron block node"
echo "==============================================="
echo "  installing neutron for block storage node"
echo "==============================================="

# database setup
mysql -e "CREATE DATABASE neutron;"
mysql -e "GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' IDENTIFIED BY '$NEUTRON_DBPASS';"
mysql -e "GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' IDENTIFIED BY '$NEUTRON_DBPASS';"

# openstack setup
srcopenrc
openstack user create --domain default --password $NEUTRON_PASS neutron

sed -i /neutronblockstat/s/1/0/ resume_status
}

swift_controller()
{
# setup controller node for swift object storage
stage="swift controller"

echo "==============================================="
echo "      installing swift controller node"
echo "==============================================="
# create openstack sift user and services
srcopenrc
openstack user create --domain default --password $SWIFT_PASS swift
openstack role add --project service --user swift admin
openstack service create --name swift --description "OpenStack Object Storage" object-store
openstack endpoint create --region RegionOne object-store public http://controller:8080/v1/AUTH_%\(project_id\)s
openstack endpoint create --region RegionOne object-store internal http://controller:8080/v1/AUTH_%\(project_id\)s
openstack endpoint create --region RegionOne object-store admin http://controller:8080/v1

# install and configure components
dnf install -y openstack-swift-proxy python-swiftclient python-keystoneclient python-keystonemiddleware memcached 
curl -o /etc/swift/proxy-server.conf https://opendev.org/openstack/swift/raw/branch/master/etc/proxy-server.conf-sample 

# setup config files
sed -i '/^\[DEFAULT\]/,/^\[/{/^[^#|\[]/s/^/#\ /g}' /etc/swift/proxy-server.conf
sed -i "/^\[DEFAULT\]/a bind_port = 8080\nuser = swift\nswift_dir = /etc/swift" /etc/swift/proxy-server.conf
sed -i '/^\[pipeline:main\]/,/^\[/{/^[^#|\[]/s/tempurl/authtoken\ keystoneauth/; /^[^#|\[]/s/tempauth//}' /etc/swift/proxy-server.conf
sed -i -e '/^\[app:proxy-server\]/,/^\[/{/egg:swift#proxy/a account_autocreate = True}' /etc/swift/proxy-server.conf
sed -i -e '/\[filter:keystoneauth\]/s/^#\ //' /etc/swift/proxy-server.conf
sed -i -e '/egg:swift#keystoneauth/{s/^#\ //' -e 'a operator_roles = admin,user}' /etc/swift/proxy-server.conf
sed -i -e '/\[filter:authtoken\]/s/^#\ //' /etc/swift/proxy-server.conf
sed -i -e "/^\[filter:authtoken\]/a paste.filter_factory = keystonemiddleware.auth_token:filter_factory\nwww_authenticate_uri = http://controller:5000\nauth_url = http://controller:5000\nmemcached_servers = controller:11211\nauth_type = password\nproject_domain_id = default\nuser_domain_id = default\nproject_name = service\nusername = swift\npassword = $SWIFT_PASS\n delay_auth_decision = True" /etc/swift/proxy-server.conf
sed -i -e '/^\[filter:cache\]/,/^\[/{/egg:swift#memcache/a memcache_servers = controller:11211}' /etc/swift/proxy-server.conf

# set resume status
sed -i /swiftctrlstat/s/1/0/ resume_status
}

swift_node()
{
# install swift object storage on a storage node
stage="swift node"



echo "==============================================="
echo "            installing swift node"
echo "==============================================="
# system setup
dnf install -y xfsprogs rsync
mkfs.xfs $storagedev1
mkfs.xfs $storagedev2

mkdir -p /srv/node/store1
mkdir -p /srv/node/store2
sdev1uuid=$(blkid | grep $storagedev1 | grep -oE '[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}')
sdev2uuid=$(blkid | grep $storagedev2 | grep -oE '[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}')
echo "UUID="$sdev1uuid" /srv/node/store1 xfs noatime 0 2" >> /etc/fstab
echo "UUID="$sdev2uuid" /srv/node/store2 xfs noatime 0 2" >> /etc/fstab

echo "uid = swift
gid = swift
log file = /var/log/rsyncd.log
pid file = /var/run/rsyncd.pid
address = $objectsoreip

[account]
max connections = 2
path = /srv/node/
read only = False
lock file = /var/lock/account.lock

[container]
max connections = 2
path = /srv/node/
read only = False
lock file = /var/lock/container.lock

[object]
max connections = 2
path = /srv/node/
read only = False
lock file = /var/lock/object.lock" > /etc/rsyncd.conf
systemctl enable rsyncd.service
systemctl start rsyncd.service

# install and configure openstack compoments
dnf install -y openstack-swift-account openstack-swift-container openstack-swift-object

curl -o /etc/swift/account-server.conf https://opendev.org/openstack/swift/raw/branch/master/etc/account-server.conf-sample
curl -o /etc/swift/container-server.conf https://opendev.org/openstack/swift/raw/branch/master/etc/container-server.conf-sample
curl -o /etc/swift/object-server.conf https://opendev.org/openstack/swift/raw/branch/master/etc/object-server.conf-sample

# account-server.conf file
sed -i -e "/^\[DEFAULT\]/,/^\[/{/bind_ip/a bind_ip = $objectstoreip\nuser = swift\nswift_dir = /etc/swift\ndevices = /srv/node\nmount_check = True}" /etc/swift/account-server.conf
sed -i -e "/^\[pipeline:main\]/,/^\[/{s/backend_ratelimit\ //}" /etc/swift/account-server.conf
sed -i -e "/^\[filter:recon\]/,/^\[/{/egg:swift#recon/a recon_cache_path = /var/cache/swift}" /etc/swift/account-server.conf

# container-server.conf
sed -i -e "/^\[DEFAULT\]/,/^\[/{/bind_port/a bind_ip = $objectstoreip\nuser = swift\nswift_dir = /etc/swift\ndevices = /srv/node\nmount_check = True}" /etc/swift/container-server.conf
sed -i -e "/^\[pipeline:main\]/,/^\[/{s/backend_ratelimit\ //}" /etc/swift/containter-server.conf
sed -i -e "/^\[filter:recon\]/,/^\[/{/egg:swift#recon/a recon_cache_path = /var/cache/swift}" /etc/swift/account-server.conf

# object-server.conf
sed -i -e "/^\[DEFAULT\]/,/^\[/{/bind_port/a bind_ip = $objectstoreip\nuser = swift\nswift_dir = /etc/swift\ndevices = /srv/node\nmount_check = True}" /etc/swift/object-server.conf
sed -i -e "/^\[pipeline:main\]/,/^\[/{s/backend_ratelimit\ //}" /etc/swift/object-server.conf
sed -i -e "/^\[filter:recon\]/,/^\[/{/egg:swift#recon/a recon_cache_path = /var/cache/swift\nrecon_lock_path = /var/lock}" /etc/swift/object-server.conf

# permissions
chown -R swift:swift /srv/node
mkdir -p /var/cache/swift
chown -R root:swift /var/cache/swift
chmod -R 775 /var/cache/swift
firewall-cmd --permanent --add-port=6200/tcp
firewall-cmd --permanent --add-port=6201/tcp
firewall-cmd --permanent --add-port=6202/tcp

sed -i /swiftnodestat/s/1/0/ resume_status
}

swift_init_rings_node()
{
cd /etc/swift
swift-ring-builder account.builder create 10 3 1
swift-ring-builder account.builder add --region 1 --zone 1 --ip STORAGE_NODE_MANAGEMENT_INTERFACE_IP_ADDRESS --port 6202 \
 --device DEVICE_NAME --weight DEVICE_WEIGHT

}

heat_controller()
{
echo "heat"

sed -i /heatctrlstat/s/1/0/ resume_status
}

controller_archetype()
{ 
echo "+++++++++++++++++++++++++++++++++++++++++++++++"
echo "        installing controler archetype  "
echo "+++++++++++++++++++++++++++++++++++++++++++++++"
# set resume if errors
sed -i /resume/s/0/1/ resume_status
resumeclean=basestat
[ "$resume" == 1 ] && [ "$basestat" == "0" ] && echo "base complete" || base_all 
resumeclean=etcdstat
[ "$resume" == 1 ] && [ "$etcdstat" == "0" ] && echo "etcd complete" || etcd_all
resumeclean=mariadbstat
[ "$resume" == 1 ] && [ "$mariadbstat" == "0" ] && echo "mariadb complete" || mariadb_controller
resumeclean=rabbitmqstat
[ "$resume" == 1 ] && [ "$rabbitmqstat" == "0" ] && echo "rabbitmq complete" || rabbitmq_controller
resumeclean=memmcachedstat
[ "$resume" == 1 ] && [ "$memcachedstat" == "0" ] && echo "memcached complete" || memcached_controller
resumeclean=keystonestat
[ "$resume" == 1 ] && [ "$keystonestat" == "0" ] && echo "keystone complete" || keystone_controller
resumeclean=glanncestat
[ "$resume" == 1 ] && [ "$glancestat" == "0" ] && echo "glance complete" || glance_controller
resumeclean=placementstat
[ "$resume" == 1 ] && [ "$placementstat" == "0" ] && echo "placement complete" || placement_controller
resumeclean=novactlstat
[ "$resume" == 1 ] && [ "$novactlstat" == "0" ] && echo "novactl complete" || nova_controller
resumeclean=cinderctlstat
[ "$resume" == 1 ] && [ "$cinderctlstat" == "0" ] && echo "cinderctl complete" || cinder_controller
resumeclean=horizonstat
[ "$resume" == 1 ] && [ "$horizonstat" == "0" ] && echo "horizon complete" || horizon
# reset resume
flush_resume
echo "+++++++++++++++++++++++++++++++++++++++++++++++"
echo "    controler archetype install complete "
echo "+++++++++++++++++++++++++++++++++++++++++++++++"
}

showips() {
echo "# controller
$controllerip	controller	

# nova compute
$computeip	compute

# cinder block storage
$blockstoreip	blockstore

# swift object storage
$objectstoreip	objectstore"
}

writehosts() {
echo -n "Enter IP for controller node 1 : "
read controllerip
echo -n "Enter IP for compute node 1 : "
read computeip
echo -n "Enter IP for block storage node 1 : "
read blockstoreip
echo -n "Enter IP for object storage node 1 : "
read objectstoreip
echo "===================================================="
echo "           New Hosts Config File       "
echo "===================================================="
echo ""
showips
}

cleanhosts() {
sed -i /controller/d /etc/hosts
sed -i /compute/d /etc/hosts
sed -i /block\ storage/d /etc/hosts
sed -i /blockstore/d /etc/hosts
sed -i /object\ storeage/d /etc/hosts
sed -i /objectstore/d /etc/hosts
}

setvars() {
# what is being installed
echo -n "Which Openstack Release? : "
read release
echo -n "Openstack Node (controller compute block object) : "
read node
echo -n "Set node IPs and optionally write to hosts file? [y/n/x]: "
read hostsfile
[ "$hostsfile" == "y" ] && writehosts || { [ "$hostsfile" == "x" ] && exit ; }

}

viewvars() {
# show current variables
echo ""
echo "===================================================="
echo "               Current IP Assignments             "
echo "===================================================="
echo ""
ip addr show | grep -E "^\s+inet\s" | sed 1d
echo ""
echo "===================================================="
echo "             Current Variable Assignments           "
echo "===================================================="
echo ""
#echo "openstack release to install=$release"
#echo "node to install=$node"
#echo "myuser=$myuser"
#echo "controller node IP=$controllerip"
#echo "compute node IP=$computeip"
#echo "block storage node IP=$blockstoreip"
#echo "object storage IP=$objectstoreip"
#echo "cinder device=$cinderdev"
#echo "cinder controller IP=$cinderctrlip"
#echo "horizon allowed hosts=$hzallowedhosts"
#echo "Time Zone Code=$srvtz"
awk 'BEGIN {FS="\="; printf "%20s%20s\n", "--Variable--", "--Value--"} /^[a-z]/{printf "%20s%25s\n", $1, $2}' openstack_vars 2>/dev/null | grep -v ^#
echo "*****Time Zone Abbr: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones*****"
echo -n "continue with current values? [y/n/x]: "
read install
case $install in 
		y	)	echo "Continuing installation..." && sleep 1 ;;
		n	)	setvars ;;
		x	)	exit ;;
		*	)	echo "Invalid response" && viewvars	;;
	esac
}

viewpasswords() {
echo "ADMIN_PASS = $ADMIN_PASS"
echo "CINDER_DBPASS = $CINDER_DBPASS"
echo "CINDER_PASS = $CINDER_PASS"
echo "DASH_DBPASS = $DASH_DBPASS"
echo "MYUSER_PASS = $MYUSER_PASS"
echo "GLANCE_DBPASS = $GLANCE_DBPASS"
echo "GLANCE_PASS = $GLANCE_PASS"
echo "KEYSTONE_DBPASS = $KEYSTONE_DBPASS"
echo "METADATA_SECRET = $METADATA_SECRET"
echo "NEUTRON_DBPASS = $NEUTRON_DBPASS"
echo "NEUTRON_PASS = $NEUTRON_PASS"
echo "NOVA_DBPASS = $NOVA_DBPASS"
echo "NOVA_PASS = $NOVA_PASS"
echo "PLACEMENT_PASS = $PLACEMENT_PASS"
echo "PLACEMENT_DBPASS=$PLACEMENT_DBPASS"
echo "RABBIT_PASS = $RABBIT_PASS"
echo "SWIFT_PASS = $SWIFT_PASS"
}

genask() {
echo -n "generate new passwords file? [y/n]> "
read gen
if [ "$gen" == "y" ]; then 
	generatepasswords
fi
}

checkpasswords() {
if [ -e "openstack_passwords" ]; then
	echo "NOTE: the openstack_passwords file exists and is automatically included"
else
	echo "NOTE: the openstack_passwords file does not exist"
	echo "Generating openstack_passwords file"
	generatepasswords
	
fi
echo -n "view passwords? [y/n]> "
read viewpw
if [ "$viewpw" == "y" ] ; then
	viewpasswords
	genask
fi

}

flush_resume()
{
# reset resume file to zeros
sed -i s/0/1/g resume_status
sed -i /resume/s/1/0/ resume_status
echo "Resume states reset for full installation" && sleep 1
}

clean_resume()
{
# fix variable to work
case $resumeclea in
	basestat		) clean_base_all ;;
	mariadbstat		) clean_etcd_all ;;
	rabbitmqstat		) clean_mariadb_controller ;;
	memcachedstat		) clean_rabbitmq_controller ;;
	etcdstat		) clean_memcached_controller ;;
	keystonestat		) clean_keystone_controller ;;
	glancestat		) clean_glance_controller ;;
	placementstat		) clean_placement_controller ;;
	novactlstat		) clean_nova_controller ;;
	novanodestat		) ;;
	cinderctlstat		) clean_cinder_controller ;;
	cindernodestat		) ;;
	cinderbackupstat	) ;;
	horizonstat		) clean_horizon ;;

esac
}

confirmvars()
{
viewvars
	echo "===================================================="
	echo "            Current Hosts Config File               "
	echo "===================================================="
	echo ""
	cat /etc/hosts
	echo ""
	echo -n "update hosts file? [y/n]> "
	read update
	[ "$update" == "y" ] && cleanhosts && showips >> /etc/hosts && echo "*****/etc/hosts updated*****" || { echo "*****/etc/hosts NOT updated*****" ; }
	checkpasswords

}

resume_state()
{
if [ "$resume" == "1" ]; then
	echo -n "It looks like the last installation didn't complete properly. Would you like to resume where it left off? [y/n]"
	read rchoice
	case $rchoice in 
		y	)	echo "Resuming previous installation..." && sleep 1; clean_resume ;;
		n	)	flush_resume; resume=0 ;;
		*	)	echo "Invalid response" && resume_state	;;
	esac
else
	confirmvars
fi
}



# default execution
# change to specific directory
dir=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
cd $dir 
# check for inclusion files
[ -e "openstack_passwords" ] && . openstack_passwords || { echo "openstack_passwords does not exist"; }
[ -e "openstack_vars" ] && . openstack_vars || { echo "openstack_vars does not exist" && exit 1; }
[ -e "resume_status" ] && . resume_status || { echo "resume_status does not exist" && exit 1; }
# startup checks
if [ "$1" ==  "" ]; then
	echo "Designed for CentOS"
	
	#check for internet access
	echo "Checking for internet ..."
	wget -q --spider http://centos.org
	if [ $? != 0 ]; then
		echo "no internet connection"
		exit 1
	fi
	resume_state
	for x in $node 
	do
		${x}_archetype
	done
else
	for arg in "$@"
	do
		$arg
	done
fi	

